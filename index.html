<!DOCTYPE html>
<html>
<head>
    <title>Smart Move</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Estilos CSS -  los mismos que ya tenías */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        h1 {
            text-align: center;
            padding: 20px 0;
            background-color: #007bff;
            color: white;
            margin: 0;
        }

        #main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        #navigation-page, #creator-page {
            padding: 20px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 95%;
            max-width: 600px;
            box-sizing: border-box;
        }

        #navigation-page h2, #creator-page h2 {
            text-align: center;
            color: #007bff;
        }

        button {
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        select, input[type="text"], input[type="time"] {
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 22px);
            box-sizing: border-box;
        }

        #stop-list li {
            margin-bottom: 5px;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        #stop-list li:last-child {
            border-bottom: none;
        }

        #map {
            height: 300px;
            width: 100%;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #time-difference {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        #next-stop-info {
            display: flex;
            justify-content: space-between;
            font-size: 1.1em;
            padding: 10px 0;
            border-top: 1px solid #eee;
        }

        #next-stop-name {
            text-align: left;
        }

        #next-stop-time {
            text-align: right;
            font-weight: bold;
        }

        #navigation-controls {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }


        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
                padding: 15px 0;
            }

            #navigation-page, #creator-page {
                padding: 15px;
                margin-bottom: 15px;
                width: 98%;
            }

            button, select, input[type="text"], input[type="time"] {
                font-size: 1em;
            }

            #time-difference {
                font-size: 1.5em;
            }
            #next-stop-info {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <h1>Smart Move</h1>

    <div id="main-container">
        <div id="navigation-page">
            <h2>Navegación</h2>
            <button id="creator-button">Crear Paradas</button>

            <label for="route-select">Seleccionar Ruta:</label>
            <select id="route-select">
                <option value="">-- Seleccionar Ruta --</option>
            </select>
            <button id="delete-route-button">Eliminar Ruta</button>

            <div id="time-difference">
                <span id="time-diff-value">--:--</span>
            </div>

            <div id="next-stop-info">
                <span id="next-stop-name"></span> <span id="next-stop-time">--:--</span>
            </div>

            <div id="navigation-controls">
                <button id="prev-stop-button">Parada Anterior</button>
                <button id="skip-stop-button">Saltar Parada</button>
            </div>
        </div>

        <div id="creator-page" style="display: none;">
            <h2>Creador de Paradas</h2>
            <div id="map"></div>
            <div id="stop-form">
                <input type="text" id="stop-name" placeholder="Nombre de la Parada">
                <input type="time" id="scheduled-time-arrival" placeholder="Horario de Llegada (HH:MM)">
                <input type="time" id="scheduled-time-departure" placeholder="Horario de Salida (HH:MM) - Opcional">
                <button id="add-stop-button">Agregar Parada</button>
            </div>
            <ul id="stop-list"></ul>
            <button id="save-route-button">Guardar Ruta</button>
            <button id="back-to-navigation-button">Volver a Navegación</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // *** Aquí va el código JavaScript reescrito ***
        const creatorButton = document.getElementById('creator-button');
        const navigationPage = document.getElementById('navigation-page');
        const creatorPage = document.getElementById('creator-page');
        const mapDiv = document.getElementById('map');
        const stopNameInput = document.getElementById('stop-name');
        const scheduledTimeArrivalInput = document.getElementById('scheduled-time-arrival');
        const scheduledTimeDepartureInput = document.getElementById('scheduled-time-departure');
        const addStopButton = document.getElementById('add-stop-button');
        const stopList = document.getElementById('stop-list');
        const saveRouteButton = document.getElementById('save-route-button');
        const backToNavigationButton = document.getElementById('back-to-navigation-button');
        const routeSelect = document.getElementById('route-select');
        const deleteRouteButton = document.getElementById('delete-route-button');
        const timeDiffValueDisplay = document.getElementById('time-diff-value');
        const nextStopNameDisplay = document.getElementById('next-stop-name');
        const nextStopTimeDisplay = document.getElementById('next-stop-time');
        const prevStopButton = document.getElementById('prev-stop-button');
        const skipStopButton = document.getElementById('skip-stop-button');


        let map;
        let stops = []; // Array para almacenar las paradas de la ruta actual
        let currentRouteName = ''; // Para el nombre de la ruta si se guarda
        let watchId; // Para la geolocalización
        let currentRouteStopsForNavigation = []; // Paradas de la ruta seleccionada para navegación
        let currentLatitude;
        let currentLongitude;
        let timeDifferenceInterval;
        let currentStopIndex = -1;
        let nextStopIndex = 0;


        // --- Funciones de la Página Creador de Paradas ---
        function showCreatorPage() {
            navigationPage.style.display = 'none';
            creatorPage.style.display = 'block';
            initCreatorMap(); // Inicializar el mapa para la creación de paradas
        }

        function initCreatorMap() {
            map = L.map('map').setView([0, 0], 2); // Centrar el mapa al inicio
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            map.on('click', onMapClick); // Listener para clicks en el mapa
        }

        function onMapClick(e) {
            let latlng = e.latlng;
            L.popup()
                .setLatLng(latlng)
                .setContent("Selecciona 'Agregar Parada' para confirmar este punto.")
                .openOn(map);

            map.tempLatLng = latlng; // Guardar las coordenadas temporalmente
        }


        function addStopToList() {
            if (!map.tempLatLng) {
                alert("Por favor, selecciona una ubicación en el mapa haciendo clic.");
                return;
            }

            const stopName = stopNameInput.value.trim();
            const scheduledTimeArrival = scheduledTimeArrivalInput.value;
            const scheduledTimeDeparture = scheduledTimeDepartureInput.value;
            const latlng = map.tempLatLng;


            if (stopName && scheduledTimeArrival) {
                const newStop = {
                    name: stopName,
                    lat: latlng.lat,
                    lng: latlng.lng,
                    scheduledArrivalTime: scheduledTimeArrival,
                    scheduledDepartureTime: scheduledTimeDeparture
                };
                stops.push(newStop); // Agregar la parada al array 'stops'
                updateStopListDisplay(); // Actualizar la lista visual de paradas
                clearStopForm(); // Limpiar el formulario después de agregar
                map.closePopup(); // Cerrar el popup del mapa
                map.tempLatLng = null; // Limpiar la latlng temporal
            } else {
                alert("Nombre de parada y Horario de Llegada son obligatorios.");
            }
        }

        function updateStopListDisplay() {
            stopList.innerHTML = ''; // Limpiar la lista visual
            stops.forEach((stop, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${stop.name} - Llegada: ${stop.scheduledArrivalTime}  (Lat: ${stop.lat.toFixed(4)}, Lng: ${stop.lng.toFixed(4)}) `;
                stopList.appendChild(listItem);
            });
        }

        function clearStopForm() {
            stopNameInput.value = '';
            scheduledTimeArrivalInput.value = '';
            scheduledTimeDepartureInput.value = '';
        }

        function saveRoute() {
            const routeName = prompt("Nombre para guardar la ruta:");
            if (routeName) {
                const routes = JSON.parse(localStorage.getItem('busRoutes') || '[]');
                routes.push({ name: routeName, stops: stops }); // Guardar la ruta con el array 'stops' actual
                localStorage.setItem('busRoutes', JSON.stringify(routes));
                loadRoutes(); // Recargar las rutas en el selector
                stops = []; // Limpiar el array de paradas para la próxima ruta
                stopList.innerHTML = ''; // Limpiar la lista visual
                alert(`Ruta "${routeName}" guardada!`);
                showNavigationPage(); // Volver a la página de navegación
            }
        }

        function showNavigationPage() {
            creatorPage.style.display = 'none';
            navigationPage.style.display = 'block';
            loadRoutes(); // Recargar las rutas al volver a navegación
        }


        // --- Funciones de Gestión de Rutas (Navigation Page) ---
        function loadRoutes() {
            routeSelect.innerHTML = '<option value="">-- Seleccionar Ruta --</option>';
            const routes = JSON.parse(localStorage.getItem('busRoutes') || '[]');
            routes.forEach((route, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = route.name;
                routeSelect.appendChild(option);
            });
        }

        function deleteRoute() {
            const selectedRouteIndex = routeSelect.value;
            if (selectedRouteIndex !== "") {
                if (confirm("¿Seguro que quieres eliminar esta ruta?")) {
                    const routes = JSON.parse(localStorage.getItem('busRoutes') || '[]');
                    routes.splice(selectedRouteIndex, 1);
                    localStorage.setItem('busRoutes', JSON.stringify(routes));
                    loadRoutes();
                    alert("Ruta eliminada.");
                }
            } else {
                alert("Selecciona una ruta para eliminar.");
            }
        }

        function loadSelectedRoute() {
            const selectedRouteIndex = routeSelect.value;
            if (selectedRouteIndex !== "") {
                const routes = JSON.parse(localStorage.getItem('busRoutes') || '[]');
                const selectedRoute = routes[selectedRouteIndex];
                if (selectedRoute) {
                    console.log("Ruta seleccionada:", selectedRoute);
                    alert(`Ruta "${selectedRoute.name}" seleccionada. Navegación lista.`);
                    currentRouteStopsForNavigation = selectedRoute.stops; // Cargar paradas para navegación
                    currentStopIndex = -1;
                    nextStopIndex = 0;
                    // Aquí podrías llamar a una función para iniciar la navegación si la tienes
                    // updateNavigationDisplay(currentLatitude, currentLongitude); // Si tienes una función de visualización de navegación
                }
            }
        }


        // --- Event Listeners ---
        creatorButton.addEventListener('click', showCreatorPage);
        backToNavigationButton.addEventListener('click', showNavigationPage);
        addStopButton.addEventListener('click', addStopToList);
        saveRouteButton.addEventListener('click', saveRoute);
        routeSelect.addEventListener('change', loadSelectedRoute);
        deleteRouteButton.addEventListener('click', deleteRoute);


        // --- Initial Load ---
        loadRoutes(); // Cargar rutas al iniciar la página

    </script>
</body>
</html>
