<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Move - Logística de Autobuses</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPvknGQwiViVtgsGaxGgE2SALgWPQTXw5Jo/aR7WPWIോട്ksXdhxnsMqa/MVdWVPdevg==" crossorigin=""/>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        #map-container { width: 100%; height: 400px; }
        #stop-list { margin-top: 10px; padding: 10px; border: 1px solid #ccc; }
        .stop-item { margin-bottom: 5px; }
        #time-diff-display { font-size: 2em; text-align: center; margin: 20px 0; }
        #next-stop-info { text-align: center; margin-bottom: 20px; }
        .button-container { text-align: center; margin-bottom: 20px; }
        button { padding: 10px 20px; margin: 0 10px; cursor: pointer; }
        .hidden { display: none; }
        #route-creation-panel, #navigation-panel { padding: 20px; }
        #route-list-container { margin-top: 10px; }
        #route-list { width: 100%; padding: 8px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1>Smart Move</h1>

    <div id="route-creation-panel">
        <h2>Crear Ruta</h2>
        <div id="map-container"></div>

        <div id="stop-creation-form">
            <h3>Agregar Parada</h3>
            <input type="text" id="stop-name" placeholder="Nombre de Parada">
            <input type="time" id="stop-time">
            <button onclick="addStop()">Agregar Parada</button>
        </div>

        <div id="stop-list">
            <h3>Paradas Agregadas</h3>
            <ul id="stops-ul"></ul>
        </div>

        <div id="route-actions">
            <input type="text" id="route-name" placeholder="Nombre de Ruta">
            <button onclick="saveRoute()">Guardar Ruta</button>
        </div>

        <div id="route-list-container">
            <h3>Rutas Guardadas</h3>
            <select id="route-list"></select>
            <button onclick="loadRoute()">Cargar Ruta</button>
            <button onclick="deleteRoute()">Eliminar Ruta</button>
        </div>
    </div>

    <div id="navigation-panel" class="hidden">
        <h2>Navegación</h2>
        <div id="time-diff-display">--:--</div>
        <div id="next-stop-info">Próxima parada: <span id="next-stop-name"></span> - <span id="next-stop-time"></span></div>
        <div class="button-container">
            <button onclick="previousStop()">Parada Anterior</button>
            <button onclick="skipStop()">Saltar Parada</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYM8mOzHVStnEQxvQ9mn程度+o+5erxVPxcOnoXyjRWRRr/RrFHbFhBmbyTuhLEejzl5gH/ErlhmcGsxkkoJw==" crossorigin=""></script>
    <script>
        let map;
        let stops = [];
        let currentRoute = null;
        let currentStopIndex = 0;
        let userLocationMarker = null;
        let watchId = null;
        let routes = {};

        function initMap() {
            map = L.map('map-container').setView([-27.4606, -58.9843], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            map.on('click', onMapClick);
        }

        function onMapClick(e) {
            let stopName = prompt("Nombre de la parada:");
            if (stopName) {
                let stopTime = prompt("Horario programado (HH:MM):");
                if (stopTime) {
                    addStopToList({
                        name: stopName,
                        latlng: e.latlng,
                        time: stopTime
                    });
                }
            }
        }

        function addStop() {
            const stopNameInput = document.getElementById('stop-name');
            const stopTimeInput = document.getElementById('stop-time');
            const stopName = stopNameInput.value.trim();
            const stopTime = stopTimeInput.value;

            if (stopName && stopTime && map.getCenter()) {
                addStopToList({
                    name: stopName,
                    latlng: map.getCenter(),
                    time: stopTime
                });
                stopNameInput.value = '';
                stopTimeInput.value = '';
            } else {
                alert("Por favor, ingrese nombre y horario de parada, y haga click en el mapa para la ubicación.");
            }
        }


        function addStopToList(stopData) {
            stops.push(stopData);
            updateStopListDisplay();

            L.marker(stopData.latlng).addTo(map)
                .bindPopup(`<b>${stopData.name}</b><br>Horario: ${stopData.time}`);
        }

        function updateStopListDisplay() {
            const stopsUl = document.getElementById('stops-ul');
            stopsUl.innerHTML = '';
            stops.forEach((stop, index) => {
                const li = document.createElement('li');
                li.classList.add('stop-item');
                li.textContent = `${stop.name} - Horario: ${stop.time} (Lat: ${stop.latlng.lat.toFixed(4)}, Lng: ${stop.latlng.lng.toFixed(4)}) `;
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Eliminar';
                removeButton.onclick = () => removeStop(index);
                li.appendChild(removeButton);
                stopsUl.appendChild(li);
            });
        }

        function removeStop(index) {
            stops.splice(index, 1);
            updateStopListDisplay();
        }

        function saveRoute() {
            const routeName = document.getElementById('route-name').value.trim();
            if (routeName && stops.length > 0) {
                routes[routeName] = {
                    stops: stops,
                    createdAt: new Date()
                };
                localStorage.setItem('smartMoveRoutes', JSON.stringify(routes));
                loadRouteList();
                alert(`Ruta "${routeName}" guardada!`);
            } else {
                alert("Por favor, ingrese un nombre para la ruta y agregue paradas.");
            }
        }

        function loadRouteList() {
            const routeListSelect = document.getElementById('route-list');
            routeListSelect.innerHTML = '';
            routes = JSON.parse(localStorage.getItem('smartMoveRoutes')) || {};

            for (const routeName in routes) {
                const option = document.createElement('option');
                option.value = routeName;
                option.textContent = routeName;
                routeListSelect.appendChild(option);
            }
        }

        function loadRoute() {
            const routeName = document.getElementById('route-list').value;
            if (routeName && routes[routeName]) {
                currentRoute = routes[routeName];
                stops = currentRoute.stops;
                updateStopListDisplay();
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                stops.forEach(stop => {
                    L.marker(stop.latlng).addTo(map)
                        .bindPopup(`<b>${stop.name}</b><br>Horario: ${stop.time}`);
                });

                document.getElementById('route-creation-panel').classList.add('hidden');
                document.getElementById('navigation-panel').classList.remove('hidden');
                startNavigation();
            } else {
                alert("Seleccione una ruta válida para cargar.");
            }
        }

        function deleteRoute() {
            const routeName = document.getElementById('route-list').value;
            if (routeName && routes[routeName]) {
                if (confirm(`¿Seguro que desea eliminar la ruta "${routeName}"?`)) {
                    delete routes[routeName];
                    localStorage.setItem('smartMoveRoutes', JSON.stringify(routes));
                    loadRouteList();
                    alert(`Ruta "${routeName}" eliminada.`);
                }
            } else {
                alert("Seleccione una ruta para eliminar.");
            }
        }


        function startNavigation() {
            currentStopIndex = 0;
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(updatePosition, handleLocationError, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                alert("Geolocalización no soportada por este navegador.");
            }
        }

        function updatePosition(position) {
            const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);

            if (!userLocationMarker) {
                userLocationMarker = L.marker(userLatLng).addTo(map)
                    .bindPopup("Tu ubicación");
            } else {
                userLocationMarker.setLatLng(userLatLng);
            }

            if (currentRoute && stops.length > 0) {
                calculateTimeDifference(); // No need to pass userLatLng anymore for time diff calculation
                checkStopProximity(userLatLng);
            }
        }

        function handleLocationError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("Permiso de geolocalización denegado.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Información de ubicación no disponible.");
                    break;
                case error.TIMEOUT:
                    alert("Tiempo de espera para obtener la ubicación agotado.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("Error desconocido de geolocalización.");
                    break;
            }
        }

        function calculateTimeDifference() { // userLatLng removed as parameter
            const currentStop = stops[currentStopIndex];
            if (!currentStop) return;

            const now = new Date();
            const scheduledTimeParts = currentStop.time.split(':');
            const scheduledTime = new Date(now);
            scheduledTime.setHours(parseInt(scheduledTimeParts[0]), parseInt(scheduledTimeParts[1]), 0, 0);

            const timeDiffMs = scheduledTime - now;
            const timeDiffSeconds = Math.round(timeDiffMs / 1000);
            const minutes = Math.floor(Math.abs(timeDiffSeconds) / 60);
            const seconds = Math.abs(timeDiffSeconds) % 60;

            const sign = timeDiffSeconds > 0 ? '+' : (timeDiffSeconds < 0 ? '-' : '+');
            const formattedTimeDiff = `${sign}${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            document.getElementById('time-diff-display').textContent = formattedTimeDiff;
            document.getElementById('next-stop-name').textContent = currentStop.name;
            document.getElementById('next-stop-time').textContent = currentStop.time;
        }

        function checkStopProximity(userLatLng) {
            const currentStop = stops[currentStopIndex];
            if (!currentStop) return;

            const stopLatLng = currentStop.latlng;
            const distance = userLatLng.distanceTo(stopLatLng);

            if (distance <= 20) {
                goToNextStop();
            }
        }

        function goToNextStop() {
            if (currentStopIndex < stops.length - 1) {
                currentStopIndex++;
                calculateTimeDifference(); // Recalculate time difference for the new stop immediately
            } else {
                alert("Has llegado al final de la ruta!");
                stopNavigation();
            }
        }

        function skipStop() {
            if (currentStopIndex < stops.length - 1) {
                currentStopIndex++;
                calculateTimeDifference(); // Recalculate time difference for the new stop immediately
            } else {
                alert("Ya estás en la última parada.");
            }
        }

        function previousStop() {
            if (currentStopIndex > 0) {
                currentStopIndex--;
                calculateTimeDifference(); // Recalculate time difference for the new stop immediately
            } else {
                alert("Ya estás en la primera parada.");
            }
        }

        function stopNavigation() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            alert("Navegación detenida.");
        }


        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadRouteList();
        });
    </script>

</body>
</html>
