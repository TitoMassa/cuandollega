<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Move</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        #map {
            height: 400px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .stop-list {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .time-display {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Smart Move</h1>
        <div id="map"></div>
        
        <div class="status">
            <h3>Estado actual</h3>
            <div class="time-display" id="time-diff">--:--</div>
            <div id="next-stop">Próxima parada: -</div>
            <div class="controls">
                <button onclick="previousStop()">Parada anterior</button>
                <button onclick="nextStop()">Saltar parada</button>
            </div>
        </div>

        <div class="stop-list">
            <h3>Lista de paradas</h3>
            <ul id="stops-list"></ul>
        </div>

        <div class="controls">
            <button onclick="addStop()">Agregar parada</button>
            <button onclick="clearRoute()">Limpiar ruta</button>
            <button onclick="saveRoute()">Guardar ruta</button>
            <button onclick="loadRoute()">Cargar ruta</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map;
        let currentRoute = [];
        let currentStopIndex = 0;
        let watchId;

        // Inicializar el mapa
        function initMap() {
            map = L.map('map').setView([0, 0], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        // Actualizar diferencia de tiempo
        function update_time_diff() {
            const now = new Date();
            const nextStop = currentRoute[currentStopIndex];
            if (!nextStop) return;

            const scheduledTime = new Date(nextStop.time);
            let diff = scheduledTime - now;
            
            if (diff < 0) diff = -diff;
            
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            const sign = diff === scheduledTime - now ? '+' : '-';
            document.getElementById('time-diff').textContent = 
                `${sign}${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Verificar proxima parada
        function checkNextStop() {
            if (currentStopIndex >= currentRoute.length) return;
            
            const currentLocation = new L.LatLng(position.coords.latitude, position.coords.longitude);
            const nextStopLocation = new L.LatLng(currentRoute[currentStopIndex].coords.lat, currentRoute[currentStopIndex].coords.lng);
            
            const distance = currentLocation.distanceTo(nextStopLocation);
            if (distance < 20) {
                currentStopIndex++;
                update_time_diff();
                updateNextStopDisplay();
            }
        }

        // Actualizar display de proxima parada
        function updateNextStopDisplay() {
            if (currentStopIndex >= currentRoute.length) {
                document.getElementById('next-stop').textContent = 'Próxima parada: -';
                return;
            }
            const nextStop = currentRoute[currentStopIndex];
            document.getElementById('next-stop').textContent = 
                `Próxima parada: ${nextStop.name} - ${new Date(nextStop.time).toLocaleTimeString()}`;
        }

        // Funcionalidades de las paradas
        function previousStop() {
            if (currentStopIndex > 0) {
                currentStopIndex--;
                updateNextStopDisplay();
                update_time_diff();
            }
        }

        function nextStop() {
            if (currentStopIndex < currentRoute.length) {
                currentStopIndex++;
                updateNextStopDisplay();
                update_time_diff();
            }
        }

        // Manejo de paradas
        function addStop() {
            map.on('click', function(e) {
                const stopName = prompt('Ingrese el nombre de la parada:');
                const stopTime = prompt('Ingrese el horario programado (YYYY-MM-DDTHH:mm):');
                
                if (stopName && stopTime) {
                    currentRoute.push({
                        name: stopName,
                        time: stopTime,
                        coords: e.latlng
                    });
                    
                    updateStopsList();
                    map.removeLayer(L.marker(e.latlng).addTo(map));
                }
            });
        }

        function updateStopsList() {
            const stopsList = document.getElementById('stops-list');
            stopsList.innerHTML = '';
            
            currentRoute.forEach((stop, index) => {
                const li = document.createElement('li');
                li.className = 'stop-item';
                li.innerHTML = `
                    ${stop.name} 
                    <span>${new Date(stop.time).toLocaleString()}</span>
                    <button onclick="removeStop(${index})">Eliminar</button>
                `;
                stopsList.appendChild(li);
            });
        }

        function removeStop(index) {
            currentRoute.splice(index, 1);
            updateStopsList();
        }

        function clearRoute() {
            currentRoute = [];
            updateStopsList();
            currentStopIndex = 0;
            update_time_diff();
            updateNextStopDisplay();
        }

        function saveRoute() {
            localStorage.setItem('currentRoute', JSON.stringify(currentRoute));
            alert('Ruta guardada correctamente');
        }

        function loadRoute() {
            const savedRoute = JSON.parse(localStorage.getItem('currentRoute'));
            if (savedRoute) {
                currentRoute = savedRoute;
                updateStopsList();
                currentStopIndex = 0;
                update_time_diff();
                updateNextStopDisplay();
            }
        }

        // Inicializar la aplicación
        function initApp() {
            initMap();
            
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        checkNextStop();
                        update_time_diff();
                    },
                    function(error) {
                        console.error('Error de geolocalización:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 1000,
                        distanceFilter: 20
                    }
                );
            } else {
                alert('La geolocalización no está soportada en este dispositivo');
            }

            // Cargar ruta guardada al inicio
            const savedRoute = JSON.parse(localStorage.getItem('currentRoute'));
            if (savedRoute) {
                currentRoute = savedRoute;
                updateStopsList();
                currentStopIndex = 0;
                update_time_diff();
                updateNextStopDisplay();
            }
        }

        // Iniciar la aplicación
        initApp();
    </script>
</body>
</html>
