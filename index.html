<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navegación Asistida</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #map {
            width: 80%;
            height: 600px;
            max-width: 1000px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #controls-container {
            width: 80%;
            max-width: 1000px;
            padding: 20px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }
        #controls {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        #timeDifference {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            text-align: center;
            margin-top: 20px;
        }
        input, button {
            margin-top: 5px;
            padding: 5px;
            font-size: 14px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls-container">
        <div id="controls">
            <button onclick="startDrawing()">Dibujar Ruta</button>
            <button onclick="addPoint()">Agregar Punto</button>
            <button onclick="editPoint()">Editar Punto</button>
            <button onclick="deletePoint()">Eliminar Punto</button>
            <button onclick="startNavigation()">Iniciar Navegación</button>
            <button onclick="loadRoute()">Cargar Ruta Guardada</button>
            <input type="datetime-local" id="pointTime" placeholder="Hora">
        </div>
        <div id="timeDifference">Diferencia de Tiempo: 00:00</div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script>
        let map;
        let draw;
        let source;
        let points = [];
        let currentPointIndex = 0;
        let watchingPosition = false;
        let positionWatchId;

        document.addEventListener('DOMContentLoaded', function() {
            source = new ol.source.Vector({});
            const vector = new ol.layer.Vector({
                source: source
            });

            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    }),
                    vector
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([-0.09, 51.505]),
                    zoom: 13
                })
            });

            // Initialize drawing interaction
            draw = new ol.interaction.Draw({
                source: source,
                type: 'LineString'
            });
            map.addInteraction(draw);

            // Event listener for drawing end
            draw.on('drawend', function(e) {
                saveRoute(e.feature);
            });

            // Start watching position
            watchPosition();
        });

        function watchPosition() {
            if (!watchingPosition) {
                positionWatchId = navigator.geolocation.watchPosition(
                    function(position) {
                        updatePosition(position.coords.latitude, position.coords.longitude);
                    },
                    function(error) {
                        console.error('Error al obtener la ubicación:', error);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
                watchingPosition = true;
            }
        }

        function updatePosition(lat, lng) {
            // Update user's position on the map
            const positionFeature = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
            });
            positionFeature.setStyle(new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 10,
                    fill: new ol.style.Fill({ color: 'blue' }),
                    stroke: new ol.style.Stroke({ color: 'white', width: 2 })
                })
            }));
            source.addFeature(positionFeature);

            // Check if user is within 20 meters of current point
            if (currentPointIndex < points.length) {
                const point = points[currentPointIndex];
                const distance = getDistance(lat, lng, point.lat, point.lng);
                if (distance <= 20) {
                    // User has reached the point
                    // Logic to handle reaching the point
                }
            }

            // Calculate time difference
            calculateTimeDifference(lat, lng);
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c;
            return d;
        }

        function addPoint() {
            const viewCenter = map.getView().getCenter();
            const centerLonLat = ol.proj.toLonLat(viewCenter);
            const time = document.getElementById('pointTime').value;
            points.push({ lat: centerLonLat[1], lng: centerLonLat[0], time: new Date(time) });
            updateRouting();
        }

        function editPoint() {
            // Implement point editing logic
        }

        function deletePoint() {
            // Implement point deletion logic
        }

        function updateRouting() {
            // Update routing based on points
            // This is a placeholder for routing logic
        }

        function saveRoute(feature) {
            const route = feature.getGeometry().getCoordinates();
            localStorage.setItem('savedRoute', JSON.stringify(route));
        }

        function loadRoute() {
            const savedRoute = localStorage.getItem('savedRoute');
            if (savedRoute) {
                const route = JSON.parse(savedRoute);
                const feature = new ol.Feature({
                    geometry: new ol.geom.LineString(route)
                });
                source.addFeature(feature);
                // Update routing based on the loaded route
                updateRouting();
            }
        }

        function startNavigation() {
            // Logic to start navigation
            watchingPosition = true;
            watchPosition();
        }
    </script>
</body>
</html>
