<!DOCTYPE html>
<html>
<head>
    <title>Smart Move</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        h1 {
            text-align: center;
            padding: 20px 0;
            background-color: #007bff;
            color: white;
            margin: 0;
        }

        #main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        #navigation-page, #creator-page {
            padding: 20px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 95%;
            max-width: 600px;
            box-sizing: border-box;
        }

        #navigation-page h2, #creator-page h2 {
            text-align: center;
            color: #007bff;
        }

        button {
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        select, input[type="text"], input[type="time"] {
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 22px);
            box-sizing: border-box;
        }

        #stop-list li {
            margin-bottom: 5px;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        #stop-list li:last-child {
            border-bottom: none;
        }

        #map {
            height: 300px;
            width: 100%;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #time-difference {
            font-size: 1.5em; /* Increased size for time difference */
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px; /* Added margin below time difference */
        }

        #next-stop-info {
            display: flex; /* Use flexbox for layout */
            justify-content: space-between; /* Space between name and time */
            font-size: 1.1em; /* Slightly larger font for next stop info */
            padding: 10px 0;
            border-top: 1px solid #eee; /* Separator line */
        }

        #next-stop-name {
            text-align: left; /* Align name to the left */
        }

        #next-stop-time {
            text-align: right; /* Align time to the right */
            font-weight: bold; /* Make time bold for emphasis */
        }


        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
                padding: 15px 0;
            }

            #navigation-page, #creator-page {
                padding: 15px;
                margin-bottom: 15px;
                width: 98%;
            }

            button, select, input[type="text"], input[type="time"] {
                font-size: 1em;
            }

            #time-difference {
                font-size: 1.5em;
            }
            #next-stop-info {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <h1>Smart Move</h1>

    <div id="main-container">
        <div id="navigation-page">
            <h2>Navegación</h2>
            <button id="creator-button">Crear Paradas</button>

            <label for="route-select">Seleccionar Ruta:</label>
            <select id="route-select">
                <option value="">-- Seleccionar Ruta --</option>
            </select>
            <button id="delete-route-button">Eliminar Ruta</button>

            <div id="time-difference">
                <span id="time-diff-value">--:--</span>
            </div>

            <div id="next-stop-info">
                <span id="next-stop-name">Próxima Parada: --</span>
                <span id="next-stop-time">--:--</span>
            </div>
        </div>

        <div id="creator-page" style="display: none;">
            <h2>Creador de Paradas</h2>
            <div id="map"></div>
            <div id="stop-form">
                <input type="text" id="stop-name" placeholder="Nombre de la Parada">
                <input type="time" id="scheduled-time">
                <button id="add-stop-button">Agregar Parada</button>
            </div>
            <ul id="stop-list"></ul>
            <button id="save-route-button">Guardar Ruta</button>
            <button id="back-to-navigation-button">Volver a Navegación</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const creatorButton = document.getElementById('creator-button');
        const navigationPage = document.getElementById('navigation-page');
        const creatorPage = document.getElementById('creator-page');
        const mapDiv = document.getElementById('map');
        const stopNameInput = document.getElementById('stop-name');
        const scheduledTimeInput = document.getElementById('scheduled-time');
        const addStopButton = document.getElementById('add-stop-button');
        const stopList = document.getElementById('stop-list');
        const saveRouteButton = document.getElementById('save-route-button');
        const backToNavigationButton = document.getElementById('back-to-navigation-button');
        const routeSelect = document.getElementById('route-select');
        const deleteRouteButton = document.getElementById('delete-route-button');
        const timeDiffValueDisplay = document.getElementById('time-diff-value');
        const nextStopNameDisplay = document.getElementById('next-stop-name');
        const nextStopTimeDisplay = document.getElementById('next-stop-time');


        let map;
        let stops = [];
        let currentRouteName = '';
        let watchId;
        let currentRouteStopsForNavigation = [];
        let currentLatitude;
        let currentLongitude;
        let timeDifferenceInterval;


        // --- Route Management Functions ---
        function saveRoute() {
            const routeName = prompt("Nombre para guardar la ruta:");
            if (routeName) {
                const routes = JSON.parse(localStorage.getItem('busRoutes') || '[]');
                routes.push({ name: routeName, stops: stops });
                localStorage.setItem('busRoutes', JSON.stringify(routes));
                loadRoutes();
                stops = [];
                stopList.innerHTML = '';
                alert(`Ruta "${routeName}" guardada!`);
                showNavigationPage();
            }
        }

        function loadRoutes() {
            routeSelect.innerHTML = '<option value="">-- Seleccionar Ruta --</option>';
            const routes = JSON.parse(localStorage.getItem('busRoutes') || '[]');
            routes.forEach((route, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = route.name;
                routeSelect.appendChild(option);
            });
        }

        function deleteRoute() {
            const selectedRouteIndex = routeSelect.value;
            if (selectedRouteIndex !== "") {
                if (confirm("¿Seguro que quieres eliminar esta ruta?")) {
                    const routes = JSON.parse(localStorage.getItem('busRoutes') || '[]');
                    routes.splice(selectedRouteIndex, 1);
                    localStorage.setItem('busRoutes', JSON.stringify(routes));
                    loadRoutes();
                    alert("Ruta eliminada.");
                }
            } else {
                alert("Selecciona una ruta para eliminar.");
            }
        }

        function loadSelectedRoute() {
            const selectedRouteIndex = routeSelect.value;
            if (selectedRouteIndex !== "") {
                const routes = JSON.parse(localStorage.getItem('busRoutes') || '[]');
                const selectedRoute = routes[selectedRouteIndex];
                if (selectedRoute) {
                    console.log("Ruta seleccionada:", selectedRoute);
                    alert(`Ruta "${selectedRoute.name}" seleccionada. Navegación lista (funcionalidad de navegación no implementada en este ejemplo básico).`);
                    currentRouteStopsForNavigation = selectedRoute.stops;
                }
            }
        }

        // --- Stop Creator Functions ---
        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            map.on('click', function(e) {
                const latlng = e.latlng;
                L.marker(latlng).addTo(map)
                    .bindPopup(`Nueva parada en: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`).openPopup();
                stopNameInput.value = '';
                scheduledTimeInput.value = '';
                stopNameInput.focus();

                map.tempLatLng = latlng;
            });
        }

        function addStopToList() {
            if (!map.tempLatLng) {
                alert("Por favor, selecciona una ubicación en el mapa primero.");
                return;
            }
            const stopName = stopNameInput.value.trim();
            const scheduledTime = scheduledTimeInput.value;
            const latlng = map.tempLatLng;

            if (stopName && scheduledTime) {
                const newStop = {
                    name: stopName,
                    lat: latlng.lat,
                    lng: latlng.lng,
                    scheduledTime: scheduledTime
                };
                stops.push(newStop);
                updateStopListDisplay();
                map.tempLatLng = null;
                L.popup().remove();
                stopNameInput.value = '';
                scheduledTimeInput.value = '';
            } else {
                alert("Por favor, ingresa nombre y horario para la parada.");
            }
        }

        function updateStopListDisplay() {
            stopList.innerHTML = '';
            stops.forEach((stop, index) => {
                const listItem = document.createElement('li');
                listItem.textContent = `${stop.name} - Horario: ${stop.scheduledTime} - Coordenadas: ${stop.lat.toFixed(4)}, ${stop.lng.toFixed(4)}`;
                stopList.appendChild(listItem);
            });
        }

        // --- Navigation Page Functions ---

        function startNavigation() {
            if (!navigator.geolocation) {
                alert("Geolocalización no es soportada por este navegador.");
                return;
            }

            function success(position) {
                currentLatitude = position.coords.latitude;
                currentLongitude = position.coords.longitude;
                // No need to call calculateTimeDifference directly here anymore, interval will handle it
            }

            function error() {
                alert("No se pudo obtener la ubicación. Asegúrate de que el GPS esté activado.");
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(success, error, options);

            // Set interval to update time difference and next stop every 5 seconds
            timeDifferenceInterval = setInterval(function() {
                if (currentLatitude !== undefined && currentLongitude !== undefined && currentRouteStopsForNavigation && currentRouteStopsForNavigation.length > 0) {
                    calculateTimeDifference(currentLatitude, currentLongitude);
                } else if (!currentRouteStopsForNavigation || currentRouteStopsForNavigation.length === 0) {
                    timeDiffValueDisplay.textContent = "--:--";
                    nextStopNameDisplay.textContent = "Próxima Parada: --";
                    nextStopTimeDisplay.textContent = "--:--";
                } else {
                    timeDiffValueDisplay.textContent = "Obteniendo ubicación...";
                    nextStopNameDisplay.textContent = "Próxima Parada: --";
                    nextStopTimeDisplay.textContent = "--:--";
                }
            }, 5000); // 5000 milliseconds = 5 seconds
        }

        function calculateTimeDifference(currentLat, currentLng) {
            if (currentRouteStopsForNavigation.length > 0) {
                const firstStop = currentRouteStopsForNavigation[0]; // Still using first stop for simplicity
                const scheduledTimeStr = firstStop.scheduledTime;
                const scheduledTimeParts = scheduledTimeStr.split(':');
                const scheduledHour = parseInt(scheduledTimeParts[0]);
                const scheduledMinute = parseInt(scheduledTimeParts[1]);

                const scheduledDate = new Date();
                scheduledDate.setHours(scheduledHour, scheduledMinute, 0, 0);

                const now = new Date();
                const timeDiffMs = scheduledDate.getTime() - now.getTime();
                const timeDiffSeconds = Math.round(timeDiffMs / 1000);

                const minutes = Math.floor(Math.abs(timeDiffSeconds) / 60);
                const seconds = Math.abs(timeDiffSeconds) % 60;
                const sign = timeDiffSeconds >= 0 ? '+' : '-';

                const formattedTimeDiff = `${sign}${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                timeDiffValueDisplay.textContent = formattedTimeDiff;

                // Update Next Stop Info
                nextStopNameDisplay.textContent = `Próxima Parada: ${firstStop.name}`;
                nextStopTimeDisplay.textContent = `${firstStop.scheduledTime}`;


            } else {
                timeDiffValueDisplay.textContent = "--:--";
                nextStopNameDisplay.textContent = "Próxima Parada: --";
                nextStopTimeDisplay.textContent = "--:--";
            }
        }


        function stopNavigation() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (timeDifferenceInterval) {
                clearInterval(timeDifferenceInterval);
                timeDifferenceInterval = null;
            }
        }


        // --- Page Visibility Functions ---
        function showCreatorPage() {
            navigationPage.style.display = 'none';
            creatorPage.style.display = 'block';
            initMap();
            stopNavigation();
        }

        function showNavigationPage() {
            creatorPage.style.display = 'none';
            navigationPage.style.display = 'block';
            stopNavigation();
            loadRoutes();
            startNavigation();
        }


        // --- Event Listeners ---
        creatorButton.addEventListener('click', showCreatorPage);
        backToNavigationButton.addEventListener('click', showNavigationPage);
        addStopButton.addEventListener('click', addStopToList);
        saveRouteButton.addEventListener('click', saveRoute);
        routeSelect.addEventListener('change', loadSelectedRoute);
        deleteRouteButton.addEventListener('click', deleteRoute);


        // --- Initial Setup ---
        showNavigationPage();
        loadRoutes();
        startNavigation();

    </script>
</body>
</html>
