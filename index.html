<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navegación Asistida</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #fff;
            display: flex;
        }
        #mapid {
            width: 50%;
            height: 100vh;
        }
        #controls-container {
            width: 50%;
            padding: 20px;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        #controls {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
        }
        #timeDifference {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
        }
        input, button {
            margin-top: 5px;
            padding: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="mapid"></div>
    <div id="controls-container">
        <div id="controls">
            <button onclick="addPoint()">Agregar Punto</button>
            <button onclick="editPoint()">Editar Punto</button>
            <button onclick="deletePoint()">Eliminar Punto</button>
            <input type="datetime-local" id="pointTime" placeholder="Hora">
            <button onclick="startNavigation()">Iniciar Navegación</button>
            <button onclick="saveRoute()">Guardar Ruta</button>
        </div>
        <div id="timeDifference">Diferencia de Tiempo: 00:00</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        let map;
        let routingControl;
        let points = [];
        let currentPointIndex = 0;
        let watchingPosition = false;
        let positionWatchId;
        let navigationStarted = false;

        document.addEventListener('DOMContentLoaded', function() {
            map = L.map('mapid').setView([51.505, -0.09], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Initialize routing control
            routingControl = L.Routing.control({
                waypoints: [],
                routeWhileDragging: false,
                fitSelectedRoutes: false,
                createMarker: function() { return null; } // Disable default markers
            }).addTo(map);
        });

        function watchPosition() {
            if (!watchingPosition) {
                positionWatchId = navigator.geolocation.watchPosition(
                    function(position) {
                        updatePosition(position.coords.latitude, position.coords.longitude);
                    },
                    function(error) {
                        console.error('Error al obtener la ubicación:', error);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
                watchingPosition = true;
            }
        }

        function updatePosition(lat, lng) {
            // Update user's position on the map
            L.circle([lat, lng], {
                color: 'blue',
                fillColor: '#ccc',
                fillOpacity: 0.5,
                radius: 20
            }).addTo(map);

            // Check if user is within 20 meters of current point
            if (currentPointIndex < points.length) {
                const point = points[currentPointIndex];
                const distance = getDistance(lat, lng, point.lat, point.lng);
                if (distance <= 20) {
                    // User has reached the point
                    currentPointIndex++;
                }
            }

            // Calculate time difference
            if (navigationStarted) {
                calculateTimeDifference(lat, lng);
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c;
            return d;
        }

        function addPoint() {
            const latlng = map.getCenter();
            const time = document.getElementById('pointTime').value;
            points.push({ lat: latlng.lat, lng: latlng.lng, time: new Date(time) });
            updateRoutingControl();
        }

        function editPoint() {
            // Implement point editing logic
        }

        function deletePoint() {
            // Implement point deletion logic
        }

        function updateRoutingControl() {
            const waypoints = points.map(point => L.latLng(point.lat, point.lng));
            routingControl.setWaypoints(waypoints);
        }

        function startNavigation() {
            navigationStarted = true;
            watchPosition();
            currentPointIndex = 0;
            calculateTimeDifference();
        }

        function saveRoute() {
            const routeName = prompt("Ingrese el nombre para la ruta:");
            if (routeName) {
                localStorage.setItem(routeName, JSON.stringify(points));
                alert('Ruta guardada exitosamente.');
            }
        }

        function calculateTimeDifference(lat, lng) {
            if (currentPointIndex >= points.length) {
                document.getElementById('timeDifference').innerText = 'Diferencia de Tiempo: Llegada';
                return;
            }

            const point = points[currentPointIndex];
            const targetTime = point.time;
            const currentTime = new Date();
            const timeDiff = targetTime - currentTime;

            let diffStr;
            if (timeDiff > 0) {
                const minutes = Math.floor(timeDiff / 60000);
                const seconds = Math.floor((timeDiff % 60000) / 1000);
                diffStr = `+${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                const minutes = Math.floor(-timeDiff / 60000);
                const seconds = Math.floor((-timeDiff % 60000) / 1000);
                diffStr = `-${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            document.getElementById('timeDifference').innerText = `Diferencia de Tiempo: ${diffStr}`;
        }
    </script>
</body>
</html>
