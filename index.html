<!DOCTYPE html>
<html>
<head>
  <title>Smart Move</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
    }
    #paradas {
      padding: 10px;
      border: 1px solid #ccc;
    }
    #paradas ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #paradas li {
      padding: 10px;
      border-bottom: 1px solid #ccc;
    }
    #paradas li:last-child {
      border-bottom: none;
    }
    #navegacion {
      padding: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Smart Move</h1>
  <div id="map"></div>
  <div id="paradas">
    <h2>Paradas</h2>
    <ul id="lista-paradas"></ul>
  </div>
  <div id="navegacion">
    <h2>Navegación</h2>
    <p id="diferencia-tiempo"></p>
    <p id="proxima-parada"></p>
    <button id="saltar-parada">Saltar parada</button>
    <button id="volver-parada">Volver a la anterior</button>
  </div>

  <script>
    // Configuración de Leaflet
    var map = L.map('map').setView([37.7749, -122.4194], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
      subdomains: ['a', 'b', 'c']
    }).addTo(map);

    // Variables globales
    var paradas = [];
    var rutaActual = null;
    var posicionActual = null;
    var proximaParada = null;

    // Función para agregar paradas
    function agregarParada(lat, lng) {
      var parada = {
        lat: lat,
        lng: lng,
        nombre: prompt('Ingrese el nombre de la parada'),
        hora: prompt('Ingrese la hora programada de la parada (HH:MM)')
      };
      paradas.push(parada);
      actualizarListaParadas();
    }

    // Función para actualizar la lista de paradas
    function actualizarListaParadas() {
      var lista = document.getElementById('lista-paradas');
      lista.innerHTML = '';
      paradas.forEach(function(parada) {
        var li = document.createElement('li');
        li.textContent = parada.nombre + ' - ' + parada.hora;
        lista.appendChild(li);
      });
    }

    // Función para guardar la ruta
    function guardarRuta() {
      rutaActual = paradas;
      localStorage.setItem('ruta', JSON.stringify(rutaActual));
      alert('Ruta guardada');
    }

    // Función para eliminar la ruta
    function eliminarRuta() {
      rutaActual = null;
      localStorage.removeItem('adas();
    }

    // Función para navegar
    function navegar() {
      if (rutaActual) {
        var posicion = obtenerPosicionActual();
        var distancia = calcularDistancia(posicion, rutaActual[0]);
        var diferenciaTiempo = calcularDiferenciaTiempo(distancia, rutaActual[0].hora);
        document.getElementById('diferencia-tiempo').textContent = diferenciaTiempo;
        proximaParada = rutaActual[0];
        document.getElementById('proxima-parada').textContent = 'Próxima parada: ' + proximaParada.nombre + ' - ' + proximaParada.hora;
      }
    }

    // Función para obtener la posición actual
    function obtenerPosicionActual() {
      navigator.geolocation.getCurrentPosition(function(position) {
        posicionActual = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
      });
      return posicionActual;
    }

    // Función para calcular la distancia entre dos puntos
    function calcularDistancia(p1, p2) {
      var lat1 = p1.lat * Math.PI / 180;
      var lng1 = p1.lng * Math.PI / 180;
      var lat2 = p2.lat * Math.PI / 180;
      var lng2 = p2.lng * Math.PI / 180;
      var dLat = lat2 - lat1;
      var dLng = lng2 - lng1;
      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) * Math.sin(dLng / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      var distancia = 6371 * c; // en kilómetros
      return distancia;
    }

    // Función para calcular la diferencia de tiempo
    function calcularDiferenciaTiempo(distancia, horaProgramada) {
      var horaActual = new Date().getHours() + ':' + new Date().getMinutes();
      var horaProgramadaParts = horaProgramada.split(':');
      var horaProgramadaMinutes = parseInt(horaProgramadaParts[0]) * 60 + parseInt(horaProgramadaParts[1]);
      var horaActualMinutes = parseInt(horaActual.split(':')[0]) * 60 + parseInt(horaActual.split(':')[1]);
      var diferenciaMinutes = horaProgramadaMinutes - horaActualMinutes;
      var diferenciaTiempo = '';
      if (diferenciaMinutes < 0) {
        diferenciaTiempo = '-' + Math.abs(diferenciaMinutes);
      } else {
        diferenciaTiempo = '+' + diferenciaMinutes;
      }
      return diferenciaTiempo;
    }

    // Eventos
    map.on('click', function(e) {
      agregarParada(e.latlng.lat, e.latlng.lng);
    });

    document.getElementById('saltar-parada').addEventListener('click', function() {
      if (proximaParada) {
        rutaActual.shift();
        proximaParada = rutaActual[0];
        document.getElementById('proxima-parada').textContent = 'Próxima parada: ' + proximaParada.nombre + ' - ' + proximaParada.hora;
      }
    });

    document.getElementById('volver-parada').addEventListener('click', function() {
      if (rutaActual.length > 1) {
        rutaActual.unshift(rutaActual.pop());
        proximaParada = rutaActual[0];
        document.getElementById('proxima-parada').textContent = 'Próxima parada: ' + proximaParada.nombre + ' - ' + proximaParada.hora;
      }
    });

    // Inicialización
    if (localStorage.getItem('ruta')) {
      rutaActual = JSON.parse(localStorage.getItem('ruta'));
      actualizarListaParadas();
    }
    navegar();
    setInterval(navegar, 1000);
  </script>
</body>
</html>
