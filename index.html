<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Move</title>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { background: black; color: white; font-family: Arial, sans-serif; text-align: center; }
        #map { height: 300px; margin-bottom: 10px; }
        .button { background: #007BFF; color: white; border: none; padding: 10px; margin: 5px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .paradas-list { text-align: left; }
        .info { font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Smart Move</h1>
    <p>Creador de rutas</p>

    <div id="map"></div>
    <button class="button" onclick="guardarRuta()">Guardar Ruta</button>
    <button class="button" onclick="eliminarRuta()">Eliminar Ruta</button>

    <h2>Paradas</h2>
    <ul id="paradas-list" class="paradas-list"></ul>

    <h2>Navegación</h2>
    <button class="button" onclick="iniciarNavegacion()">Iniciar Navegación</button>
    <button class="button" onclick="detenerNavegacion()">Detener Navegación</button>
    <p id="diferencia-tiempo" class="info">Diferencia: --:--</p>
    <p id="proxima-parada">Próxima parada: -</p>
    <button class="button" onclick="saltarParada()">Saltar Parada</button>
    <button class="button" onclick="volverParada()">Volver a la Anterior</button>

    <script>
        let map = L.map('map').setView([0, 0], 15);
        let paradas = [];
        let ruta = [];
        let indexParada = 0;
        let gpsActivo = false;
        let watchID;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        function obtenerGPS() {
            if (navigator.geolocation) {
                watchID = navigator.geolocation.watchPosition(
                    pos => {
                        map.setView([pos.coords.latitude, pos.coords.longitude], 15);
                        if (gpsActivo) {
                            verificarTiempo(pos.coords.latitude, pos.coords.longitude);
                        }
                    },
                    err => console.log("Error obteniendo GPS: ", err),
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            }
        }

        function agregarParada(e) {
            let nombre = prompt("Nombre de la parada:");
            if (!nombre) return;
            let horarioLlegada = prompt("Horario de llegada (HH:MM):");
            let horarioSalida = prompt("Horario de salida (HH:MM):");
            
            if (!horarioLlegada.match(/^\d{2}:\d{2}$/) || !horarioSalida.match(/^\d{2}:\d{2}$/)) {
                alert("Formato incorrecto. Use HH:MM.");
                return;
            }

            let parada = { lat: e.latlng.lat, lng: e.latlng.lng, nombre, horarioLlegada, horarioSalida };
            paradas.push(parada);
            L.marker([parada.lat, parada.lng]).addTo(map).bindPopup(`${nombre} - Llegada: ${horarioLlegada} / Salida: ${horarioSalida}`);
            actualizarListaParadas();
        }

        function actualizarListaParadas() {
            let lista = document.getElementById("paradas-list");
            lista.innerHTML = "";
            paradas.forEach((p, i) => {
                let item = document.createElement("li");
                item.innerText = `${p.nombre} - Llegada: ${p.horarioLlegada} / Salida: ${p.horarioSalida}`;
                lista.appendChild(item);
            });
        }

        function guardarRuta() {
            if (paradas.length === 0) {
                alert("Agregue paradas antes de guardar.");
                return;
            }
            ruta = [...paradas];
            alert("Ruta guardada.");
        }

        function eliminarRuta() {
            ruta = [];
            alert("Ruta eliminada.");
        }

        function iniciarNavegacion() {
            if (ruta.length === 0) {
                alert("No hay una ruta guardada.");
                return;
            }
            gpsActivo = true;
            obtenerGPS();
            indexParada = 0;
            actualizarProximaParada();
            alert("Navegación iniciada.");
        }

        function detenerNavegacion() {
            gpsActivo = false;
            navigator.geolocation.clearWatch(watchID);
            alert("Navegación detenida.");
        }

        function actualizarProximaParada() {
            if (indexParada < ruta.length) {
                document.getElementById("proxima-parada").innerText = `Próxima parada: ${ruta[indexParada].nombre} (Llegada: ${ruta[indexParada].horarioLlegada} / Salida: ${ruta[indexParada].horarioSalida})`;
            } else {
                document.getElementById("proxima-parada").innerText = "Fin de la ruta";
            }
        }

        function verificarTiempo(lat, lng) {
            if (indexParada >= ruta.length) return;
            
            let parada = ruta[indexParada];
            let distancia = calcularDistancia(lat, lng, parada.lat, parada.lng);

            let horaActual = new Date();
            let horaParada = new Date();
            let [hh, mm] = parada.horarioLlegada.split(":").map(Number);
            horaParada.setHours(hh, mm, 0);

            let diferencia = Math.round((horaActual - horaParada) / 1000);
            let minutos = Math.floor(Math.abs(diferencia) / 60);
            let segundos = Math.abs(diferencia) % 60;
            let signo = diferencia < 0 ? "-" : "+";

            let diferenciaTexto = `${signo}${minutos.toString().padStart(2, "0")}:${segundos.toString().padStart(2, "0")}`;
            document.getElementById("diferencia-tiempo").innerText = `Diferencia: ${diferenciaTexto}`;

            if (distancia > 20) {
                alert(`Has pasado la parada: ${parada.nombre}`);
                indexParada++;
                actualizarProximaParada();
            }
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function saltarParada() {
            indexParada++;
            actualizarProximaParada();
        }

        function volverParada() {
            if (indexParada > 0) indexParada--;
            actualizarProximaParada();
        }

        map.on('click', agregarParada);
    </script>

</body>
</html>
