<!DOCTYPE html>
<html>
<head>
    <title>Navegación Asistida</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 400px; }
        #controls { padding: 10px; display: flex; flex-direction: column; }
        #controls label, #controls input, #controls button, #timeDifference { margin-bottom: 10px; }
        #timeDifference { font-size: 1.2em; font-weight: bold; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>

    <h1>Navegación Asistida</h1>

    <div id="controls">
        <label for="startTime">Hora de Salida:</label>
        <input type="time" id="startTime" value="10:00">

        <label for="destinationTime">Hora de Llegada:</label>
        <input type="time" id="destinationTime" value="11:00">

        <button id="startNavigation">Iniciar Navegación</button>
    </div>

    <div id="map"></div>

    <div id="timeDifference">Esperando inicio...</div>

    <script>
        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var startMarker = null;
        var destinationMarker = null;
        var startTimeInput = document.getElementById('startTime');
        var destinationTimeInput = document.getElementById('destinationTime');
        var startNavigationButton = document.getElementById('startNavigation');
        var timeDifferenceDisplay = document.getElementById('timeDifference');

        var plannedDepartureTime = null;
        var plannedArrivalTime = null;
        var navigationActive = false;
        var watchId = null;
        var totalPlannedDistance = 0; // Distancia total planificada
        var userLocation = null; // Ubicación actual del usuario (LatLng)


        function updateTimeDifference() {
            if (!navigationActive || !plannedDepartureTime || !plannedArrivalTime || !startMarker || !destinationMarker || !userLocation) return;

            var now = new Date();
            var currentTime = now.getTime();
            var departureTime = plannedDepartureTime.getTime();
            var arrivalTime = plannedArrivalTime.getTime();

            var plannedDuration = arrivalTime - departureTime; // Duración planificada en milisegundos

            var distanceToDestination = userLocation.distanceTo(destinationMarker.getLatLng()); // Distancia actual al destino en metros

            if (totalPlannedDistance <= 0) {
                timeDifferenceDisplay.textContent = "Distancia no calculada."; // Avoid division by zero if distance is not available
                return;
            }

            var spatialProgress = (totalPlannedDistance - distanceToDestination) / totalPlannedDistance;

            if (spatialProgress < 0) spatialProgress = 0; // Ensure progress is not negative if user goes beyond destination
            if (spatialProgress > 1) spatialProgress = 1; // Ensure progress does not exceed 1 if user goes beyond destination

            var expectedElapsedTime = spatialProgress * plannedDuration;
            var expectedTime = departureTime + expectedElapsedTime;

            var timeDifferenceMs = expectedTime - currentTime; // Diferencia: Positivo -> Adelantado, Negativo -> Atrasado

            var differenceSign = timeDifferenceMs >= 0 ? '+' : '-';
            timeDifferenceMs = Math.abs(timeDifferenceMs);

            var minutes = Math.floor((timeDifferenceMs / (1000 * 60)) % 60);
            var totalMinutes = Math.floor(timeDifferenceMs / (1000 * 60)); // Total minutes for format -MM:SS correctly
            var seconds = Math.floor((timeDifferenceMs / 1000) % 60);

            var formattedMinutes = String(totalMinutes).padStart(2, '0'); // Use total minutes here
            var formattedSeconds = String(seconds).padStart(2, '0');

            timeDifferenceDisplay.textContent = differenceSign + formattedMinutes + ':' + formattedSeconds;
        }


        function startNavigation() {
            if (!startMarker || !destinationMarker) {
                alert("Por favor, selecciona un punto de inicio y un punto de destino en el mapa.");
                return;
            }

            plannedDepartureTime = parseTimeInputValue(startTimeInput.value);
            plannedArrivalTime = parseTimeInputValue(destinationTimeInput.value);

            if (!plannedDepartureTime || !plannedArrivalTime) {
                alert("Por favor, introduce horarios de salida y llegada válidos.");
                return;
            }

            if (plannedArrivalTime <= plannedDepartureTime) {
                alert("La hora de llegada debe ser posterior a la hora de salida.");
                return;
            }

            totalPlannedDistance = startMarker.getLatLng().distanceTo(destinationMarker.getLatLng()); // Calculate total distance

            navigationActive = true;
            startNavigationButton.disabled = true;
            timeDifferenceDisplay.textContent = "Calculando diferencia de tiempo...";

            setInterval(updateTimeDifference, 1000);

            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    function(position) {
                        userLocation = L.latLng(position.coords.latitude, position.coords.longitude); // Update user location
                        console.log("Posición GPS actualizada:", position.coords.latitude, position.coords.longitude);
                        // You could add a marker for the user's current location if needed.
                    },
                    function(error) {
                        console.error("Error al obtener la ubicación GPS:", error.message);
                        alert("Error al obtener la ubicación GPS: " + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 10000
                    }
                );
            } else {
                alert("Geolocalización no soportada por este navegador.");
            }
        }

        function parseTimeInputValue(timeString) {
            if (!timeString) return null;
            var parts = timeString.split(':');
            if (parts.length !== 2) return null;
            var hours = parseInt(parts[0], 10);
            var minutes = parseInt(parts[1], 10);
            if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                return null;
            }
            var now = new Date();
            var plannedTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0, 0);
            return plannedTime;
        }


        map.on('click', function(e) {
            if (!startMarker) {
                if (startMarker) {
                    map.removeLayer(startMarker);
                }
                startMarker = L.marker(e.latlng).addTo(map).bindPopup("Punto de Inicio").openPopup();
                if (destinationMarker) {
                    totalPlannedDistance = startMarker.getLatLng().distanceTo(destinationMarker.getLatLng()); // Recalculate distance if start marker changes and destination exists
                }
            } else if (!destinationMarker) {
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }
                destinationMarker = L.marker(e.latlng).addTo(map).bindPopup("Punto de Destino").openPopup();
                totalPlannedDistance = startMarker.getLatLng().distanceTo(destinationMarker.getLatLng()); // Calculate distance when destination is set
            } else {
                alert("Ya has seleccionado punto de inicio y destino. Para volver a empezar, recarga la página.");
            }
        });

        startNavigationButton.addEventListener('click', startNavigation);

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    map.setView([position.coords.latitude, position.coords.longitude], 13);
                },
                function(error) {
                    console.error("Error al obtener la ubicación inicial:", error.message);
                    alert("Error al obtener la ubicación inicial: " + error.message + ". Usando vista de mapa predeterminada.");
                }
            );
        } else {
            alert("Geolocalización no soportada por este navegador. Usando vista de mapa predeterminada.");
        }
    </script>

</body>
</html>
