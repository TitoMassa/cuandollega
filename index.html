<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Move</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        .page { display: none; }
        .active-page { display: block; }
        #map { height: 400px; margin: 20px 0; }
        .stop-list { margin: 20px 0; }
        .stop-item { padding: 10px; border: 1px solid #ccc; margin: 5px 0; }
        .time-difference { font-size: 2em; font-weight: bold; text-align: center; margin: 20px; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <!-- Página principal -->
    <div id="main-page" class="page active-page">
        <h1>Smart Move</h1>
        <button onclick="showPage('creator-page')">Crear Ruta</button>
        <select id="route-selector"></select>
        <div class="time-difference" id="time-display">--:--</div>
    </div>

    <!-- Creador de rutas -->
    <div id="creator-page" class="page">
        <h1>Creador de Rutas</h1>
        <button onclick="showPage('main-page')">Volver</button>
        <div id="map"></div>
        <div id="stop-creator">
            <input type="text" id="stop-name" placeholder="Nombre de la parada">
            <input type="time" id="stop-time">
            <button onclick="addStopFromMap()">Agregar Parada</button>
        </div>
        <div class="stop-list" id="stops-list"></div>
        <input type="text" id="route-name" placeholder="Nombre de la ruta">
        <button onclick="saveRoute()">Guardar Ruta</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let currentPosition = null;
        let map = null;
        let stops = [];
        let routes = JSON.parse(localStorage.getItem('routes') || '[]');
        let watchId = null;

        // Configurar mapa Leaflet
        function initMap() {
            map = L.map('map').setView([19.4326, -99.1332], 13); // Coordenadas iniciales CDMX
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            map.on('click', function(e) {
                document.getElementById('stop-name').focus();
            });
        }

        // Mostrar páginas
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById(pageId).classList.add('active-page');
            
            if(pageId === 'creator-page') {
                initMap();
            } else {
                startGPS();
                updateRouteSelector();
            }
        }

        // GPS
        function startGPS() {
            if(navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        currentPosition = position;
                        calculateTimeDifference();
                    },
                    error => alert('Error de GPS: ' + error.message),
                    { enableHighAccuracy: true, maximumAge: 10000 }
                );
            }
        }

        // Agregar parada
        function addStopFromMap() {
            const name = document.getElementById('stop-name').value;
            const time = document.getElementById('stop-time').value;
            
            if(map && name && time) {
                const coord = map.getCenter();
                stops.push({
                    lat: coord.lat,
                    lng: coord.lng,
                    name: name,
                    time: time
                });
                
                updateStopList();
                L.marker([coord.lat, coord.lng])
                 .addTo(map)
                 .bindPopup(`${name}<br>${time}`);
            }
        }

        // Actualizar lista de paradas
        function updateStopList() {
            const list = document.getElementById('stops-list');
            list.innerHTML = stops.map((stop, index) => `
                <div class="stop-item">
                    ${index + 1}. ${stop.name} - ${stop.time} 
                    (${stop.lat.toFixed(4)}, ${stop.lng.toFixed(4)})
                </div>
            `).join('');
        }

        // Guardar ruta
        function saveRoute() {
            const routeName = document.getElementById('route-name').value;
            if(routeName && stops.length > 1) {
                routes.push({
                    name: routeName,
                    stops: stops,
                    created: new Date()
                });
                localStorage.setItem('routes', JSON.stringify(routes));
                alert('Ruta guardada!');
                stops = [];
                updateStopList();
            }
        }

        // Selector de rutas
        function updateRouteSelector() {
            const selector = document.getElementById('route-selector');
            selector.innerHTML = routes.map(route => 
                `<option>${route.name}</option>`
            ).join('');
        }

        // Calcular diferencia de tiempo
        function calculateTimeDifference() {
            const selectedRoute = routes.find(r => r.name === document.getElementById('route-selector').value);
            if(!selectedRoute || !currentPosition) return;

            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();

            // Lógica de cálculo de tiempo aquí (implementar según necesidades específicas)
            // Este es un ejemplo básico
            const timeDifference = -3 * 60 - 28; // Ejemplo: -3:28
            const sign = timeDifference >= 0 ? '+' : '-';
            const absDiff = Math.abs(timeDifference);
            const minutes = Math.floor(absDiff / 60).toString().padStart(2, '0');
            const seconds = (absDiff % 60).toString().padStart(2, '0');
            
            document.getElementById('time-display').textContent = `${sign}${minutes}:${seconds}`;
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            updateRouteSelector();
            startGPS();
        });
    </script>
</body>
</html>
