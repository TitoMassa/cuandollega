<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Move</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 500px;
            width: 100%;
        }
        #controls {
            padding: 10px;
        }
        #stop-list {
            margin-top: 20px;
        }
        .stop-item {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Smart Move</h1>
    <div id="map"></div>
    <div id="controls">
        <button id="add-stop-btn">Agregar Parada</button>
        <button id="save-route-btn">Guardar Ruta</button>
        <button id="delete-route-btn">Eliminar Ruta</button>
        <button id="start-navigation-btn">Iniciar Navegación</button>
        <button id="stop-navigation-btn">Detener Navegación</button>
    </div>
    <div id="stop-list">
        <h2>Paradas:</h2>
        <ul id="stops"></ul>
    </div>
    <div id="navigation">
        <h2>Navegación:</h2>
        <p id="time-difference">Diferencia de Tiempo: </p>
        <p id="next-stop">Próxima Parada: </p>
        <button id="skip-stop-btn">Saltar Parada</button>
        <button id="previous-stop-btn">Volver a Parada Anterior</button>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Inicializar el mapa centrado en Corrientes, Argentina
        var map = L.map('map').setView([-27.4692, -58.8307], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var stops = [];
        var currentStopIndex = 0;
        var navigationActive = false;
        var navigationInterval;

        map.on('click', function(e) {
            var stopName = prompt("Nombre de la parada:");
            var stopTime = prompt("Hora programada (HH:MM):");
            if (stopName && stopTime) {
                var stop = {
                    name: stopName,
                    time: stopTime,
                    latlng: e.latlng
                };
                stops.push(stop);
                L.marker(e.latlng).addTo(map).bindPopup(`Parada: ${stopName}, Hora: ${stopTime}`).openPopup();
                updateStopList();
            }
        });

        function updateStopList() {
            var stopList = document.getElementById('stops');
            stopList.innerHTML = '';
            stops.forEach(function(stop, index) {
                var li = document.createElement('li');
                li.className = 'stop-item';
                li.textContent = `${index + 1}. ${stop.name} - ${stop.time}`;
                stopList.appendChild(li);
            });
        }

        document.getElementById('save-route-btn').addEventListener('click', function() {
            alert('Ruta guardada');
        });

        document.getElementById('delete-route-btn').addEventListener('click', function() {
            stops = [];
            currentStopIndex = 0;
            updateStopList();
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            alert('Ruta eliminada');
        });

        document.getElementById('start-navigation-btn').addEventListener('click', function() {
            if (!navigationActive) {
                navigationActive = true;
                navigationInterval = setInterval(updateNavigation, 5000); // Actualizar cada 5 segundos
                alert('Navegación iniciada');
            }
        });

        document.getElementById('stop-navigation-btn').addEventListener('click', function() {
            if (navigationActive) {
                navigationActive = false;
                clearInterval(navigationInterval);
                alert('Navegación detenida');
            }
        });

        document.getElementById('skip-stop-btn').addEventListener('click', function() {
            if (currentStopIndex < stops.length - 1) {
                currentStopIndex++;
                updateNavigation();
            }
        });

        document.getElementById('previous-stop-btn').addEventListener('click', function() {
            if (currentStopIndex > 0) {
                currentStopIndex--;
                updateNavigation();
            }
        });

        function updateNavigation() {
            if (stops.length === 0) return;

            var nextStop = stops[currentStopIndex];
            document.getElementById('next-stop').textContent = `Próxima Parada: ${nextStop.name} - ${nextStop.time}`;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var userPosition = L.latLng(position.coords.latitude, position.coords.longitude);
                    var distance = userPosition.distanceTo(nextStop.latlng);

                    if (distance > 20) {
                        currentStopIndex++;
                        if (currentStopIndex < stops.length) {
                            nextStop = stops[currentStopIndex];
                            document.getElementById('next-stop').textContent = `Próxima Parada: ${nextStop.name} - ${nextStop.time}`;
                        }
                    }

                    calculateTimeDifference(nextStop, userPosition);
                });
            } else {
                alert('Geolocalización no soportada por este navegador.');
            }
        }

        function calculateTimeDifference(nextStop, userPosition) {
            var nextStopTime = new Date(`1970-01-01T${nextStop.time}:00`);
            var currentTime = new Date();
            var timeDiff = (nextStopTime - currentTime) / 1000;
            var minutes = Math.floor(timeDiff / 60);
            var seconds = Math.floor(timeDiff % 60);
            var timeDiffStr = (timeDiff >= 0 ? '+' : '-') + String(Math.abs(minutes)).padStart(2, '0') + ':' + String(Math.abs(seconds)).padStart(2, '0');
            document.getElementById('time-difference').textContent = `Diferencia de Tiempo: ${timeDiffStr}`;
        }
    </script>
</body>
</html>
