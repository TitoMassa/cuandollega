<!DOCTYPE html>
<html>
<head>
    <title>Smart Move</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 400px;
            margin-bottom: 20px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .controls {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
        }
        button:hover {
            background: #0056b3;
        }
        .stop-list {
            list-style: none;
            padding: 0;
        }
        .stop-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        #timeDifference {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Smart Move</h1>
    <div id="map"></div>
    <div class="grid-container">
        <div class="controls">
            <button onclick="startCreatingRoute()">Nueva Ruta</button>
            <button onclick="saveRoute()">Guardar Ruta</button>
            <select id="savedRoutes" onchange="loadRoute(this.value)"></select>
            <button onclick="deleteRoute()">Eliminar Ruta</button>
            <ul id="stopsList" class="stop-list"></ul>
        </div>
        <div>
            <div id="timeDifference">--:--</div>
            <div id="navigationInfo">
                <button onclick="previousStop()">Parada Anterior</button>
                <button onclick="nextStop()">Siguiente Parada</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map, currentRoute = {}, currentPosition, watchId;
        let creatingRoute = false;
        let routes = JSON.parse(localStorage.getItem('routes') || '[]');
        let currentStopIndex = 0;

        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([19.4326, -99.1332], 13); // Coordenadas iniciales CDMX
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            map.on('click', (e) => {
                if(creatingRoute) addStopToRoute(e.latlng);
            });
        }

        // Administración de rutas
        function startCreatingRoute() {
            creatingRoute = true;
            currentRoute = {stops: []};
            document.getElementById('stopsList').innerHTML = '';
        }

        function addStopToRoute(latlng) {
            const name = prompt('Nombre de la parada:');
            const time = prompt('Hora programada (HH:MM):');
            currentRoute.stops.push({latlng, name, time});
            updateStopsList();
        }

        function saveRoute() {
            if(!currentRoute.stops?.length) return;
            currentRoute.name = prompt('Nombre de la ruta:');
            routes.push(currentRoute);
            localStorage.setItem('routes', JSON.stringify(routes));
            updateRoutesList();
            creatingRoute = false;
        }

        function updateRoutesList() {
            const select = document.getElementById('savedRoutes');
            select.innerHTML = routes.map((r,i) => 
                `<option value="${i}">${r.name}</option>`);
        }

        function loadRoute(index) {
            currentRoute = routes[index];
            currentStopIndex = 0;
            startNavigation();
        }

        function deleteRoute() {
            const index = document.getElementById('savedRoutes').value;
            routes.splice(index, 1);
            localStorage.setItem('routes', JSON.stringify(routes));
            updateRoutesList();
        }

        // Navegación
        function startNavigation() {
            if(watchId) navigator.geolocation.clearWatch(watchId);
            watchId = navigator.geolocation.watchPosition(position => {
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                updateTimeDifference();
            }, console.error, {enableHighAccuracy: true});
        }

        function updateTimeDifference() {
            if(!currentRoute.stops) return;
            
            const nextStop = currentRoute.stops[currentStopIndex];
            const distance = getDistance(currentPosition, nextStop.latlng);
            
            if(distance < 20 && currentStopIndex < currentRoute.stops.length - 1) {
                currentStopIndex++;
            }
            
            const scheduledTime = new Date();
            const [hours, minutes] = nextStop.time.split(':');
            scheduledTime.setHours(hours, minutes, 0);
            
            const diff = Math.floor((scheduledTime - new Date()) / 1000);
            const sign = diff < 0 ? '-' : '+';
            const mins = Math.abs(Math.floor(diff / 60)).toString().padStart(2, '0');
            const secs = Math.abs(diff % 60).toString().padStart(2, '0');
            
            document.getElementById('timeDifference').textContent = `${sign}${mins}:${secs}`;
        }

        function getDistance(pos1, pos2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const φ1 = pos1.lat * Math.PI/180;
            const φ2 = pos2.lat * Math.PI/180;
            const Δφ = (pos2.lat-pos1.lat) * Math.PI/180;
            const Δλ = (pos2.lng-pos1.lng) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function previousStop() {
            if(currentStopIndex > 0) currentStopIndex--;
        }

        function nextStop() {
            if(currentStopIndex < currentRoute.stops.length - 1) currentStopIndex++;
        }

        function updateStopsList() {
            const list = document.getElementById('stopsList');
            list.innerHTML = currentRoute.stops.map((stop, i) => `
                <li class="stop-item">
                    ${i+1}. ${stop.name} - ${stop.time}
                </li>
            `).join('');
        }

        // Inicialización
        initMap();
        updateRoutesList();
    </script>
</body>
</html>
