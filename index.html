<!DOCTYPE html>
<html>
<head>
  <title>Smart Move</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
    }
    #paradas {
      padding: 10px;
      border: 1px solid #ccc;
    }
    #paradas ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #paradas li {
      padding: 10px;
      border-bottom: 1px solid #ccc;
    }
    #paradas li:last-child {
      border-bottom: none;
    }
    #navegacion {
      padding: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Smart Move</h1>
  <div id="map"></div>
  <div id="paradas">
    <h2>Paradas</h2>
    <ul id="lista-paradas"></ul>
  </div>
  <div id="navegacion">
    <h2>Navegación</h2>
    <p id="diferencia-tiempo"></p>
    <p id="proxima-parada"></p>
    <button id="saltar-parada">Saltar parada</button>
    <button id="volver-parada">Volver parada</button>
  </div>

  <script>
    // Configuración de Leaflet
    var map = L.map('map').setView([37.7749, -122.4194], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
      subdomains: ['a', 'b', 'c']
    }).addTo(map);

    // Variables globales
    var paradas = [];
    var rutaActual = null;
    var posicionActual = null;
    var proximaParada = null;

    // Función para agregar paradas
    function agregarParada(lat, lng) {
      var parada = {
        lat: lat,
        lng: lng,
        nombre: prompt('Ingrese el nombre de la parada'),
        hora: prompt('Ingrese la hora programada de la parada (HH:MM)')
      };
      paradas.push(parada);
      actualizarListaParadas();
    }

    // Función para actualizar la lista de paradas
    function actualizarListaParadas() {
      var lista = document.getElementById('lista-paradas');
      lista.innerHTML = '';
      paradas.forEach(function(parada) {
        var li = document.createElement('li');
        li.textContent = parada.nombre + ' - ' + parada.hora;
        lista.appendChild(li);
      });
    }

    // Función para guardar la ruta
    function guardarRuta() {
      rutaActual = paradas;
      localStorage.setItem('ruta', JSON.stringify(rutaActual));
      alert('Ruta guardada');
    }

    // Función para eliminar la ruta
    function eliminarRuta() {
      rutaActual = null;
      localStorage.removeItem('ruta');
      paradas = [];
      actualizarListaParadas();
      alert('Ruta eliminada');
    }

    // Función para navegar
    function navegar() {
      if (rutaActual) {
        var posicion = navigator.geolocation.getCurrentPosition(function(position) {
          posicionActual = position.coords;
          var distancia = calcularDistancia(posicionActual.latitude, posicionActual.longitude, proximaParada.lat, proximaParada.lng);
          var diferenciaTiempo = calcularDiferenciaTiempo(distancia, proximaParada.hora);
          document.getElementById('diferencia-tiempo').textContent = diferenciaTiempo;
          document.getElementById('proxima-parada').textContent = proximaParada.nombre + ' - ' + proximaParada.hora;
        }, function(error) {
          alert('Error al obtener la posición');
        });
      }
    }

    // Función para calcular la distancia entre dos puntos
    function calcularDistancia(lat1, lng1, lat2, lng2) {
      var R = 6371; // Radio de la Tierra en km
      var dLat = (lat2 - lat1) * Math.PI / 180;
      var dLng = (lng2 - lng1) * Math.PI / 180;
      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng / 2) * Math.sin(dLng / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      var distancia = R * c;
      return distancia;
    }

    // Función para calcular la diferencia de tiempo
    function calcularDiferenciaTiempo(distancia, horaProgramada) {
      var horaActual = new Date().getHours() + ':' + new Date().getMinutes();
      var diferencia = calcularDiferenciaMinutos(horaActual, horaProgramada);
      if (diferencia < 0) {
        return '-' + Math.abs(diferencia).toString().padStart(2, '0') + ':' + Math.abs(diferencia % 60).toString().padStart(2, '0');
      } else {
        return '+' + Math.abs(diferencia).toString().padStart(2, '0') + ':' + Math.abs(diferencia % 60).toString().padStart(2, '0');
      }
    }

    // Función para calcular la diferencia de minutos
    function calcularDiferenciaMinutos(hora1, hora2) {
      var minutos1 = parseInt(hora1.split(':')[0]) * 60 + parseInt(hora1.split(':')[1]);
      var minutos2 = parseInt(hora2.split(':')[0]) * 60 + parseInt(hora2.split(':')[1]);
      return minutos2 - minutos1;
    }

    // Eventos
    map.on('click', function(e) {
      agregarParada(e.latlng.lat, e.latlng.lng);
    });

    document.getElementById('saltar-parada').addEventListener('click', function() {
      if (proximaParada) {
        proximaParada = rutaActual[rutaActual.indexOf(proximaParada) + 1];
        navegar();
      }
    });

    document.getElementById('volver-parada').addEventListener('click', function() {
      if (proximaParada) {
        proximaParada = rutaActual[rutaActual.indexOf(proximaParada) - 1];
        navegar();
      }
    });

    document.getElementById('guardar-ruta').addEventListener('click', guardarRuta);
    document.getElementById('eliminar-ruta').addEventListener('click', eliminarRuta);

    // Inicialización
    if (localStorage.getItem('ruta')) {
      rutaActual = JSON.parse(localStorage.getItem('ruta'));
      paradas = rutaActual;
      actualizarListaParadas();
    }

    navegar();
  </script>
</body>
</html>
