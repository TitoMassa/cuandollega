<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Move</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        #controls, #navigation {
            width: 90%;
            max-width: 600px;
            margin-bottom: 20px;
        }
        #controls button, #navigation button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        #stop-list {
            width: 90%;
            max-width: 600px;
            margin-bottom: 20px;
        }
        .stop-item {
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }
        #time-difference, #next-stop {
            font-size: 18px;
            margin-bottom: 10px;
        }
        #route-selector {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        #coordinates {
            font-size: 16px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Smart Move</h1>
    <div id="map"></div>
    <div id="controls">
        <select id="route-selector">
            <option value="">Seleccionar Ruta</option>
        </select>
        <button id="add-stop-btn">Agregar Parada</button>
        <button id="save-route-btn">Guardar Ruta</button>
        <button id="delete-route-btn">Eliminar Ruta</button>
        <button id="start-navigation-btn">Iniciar Navegación</button>
        <button id="stop-navigation-btn">Detener Navegación</button>
    </div>
    <div id="stop-list">
        <h2>Paradas:</h2>
        <ul id="stops"></ul>
    </div>
    <div id="navigation">
        <h2>Navegación:</h2>
        <p id="time-difference">Diferencia de Tiempo: </p>
        <p id="next-stop">Próxima Parada: </p>
        <button id="skip-stop-btn">Saltar Parada</button>
        <button id="previous-stop-btn">Volver a Parada Anterior</button>
    </div>
    <div id="coordinates">
        <h2>Coordenadas Actuales:</h2>
        <p id="current-coordinates">Obteniendo ubicación...</p>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Inicializar el mapa centrado en Corrientes, Argentina
        var map = L.map('map').setView([-27.4692, -58.8307], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var stops = [];
        var currentStopIndex = 0;
        var navigationActive = false;
        var navigationInterval;
        var selectedRoute = null;
        var userPosition = null;

        // Cargar rutas guardadas
        function loadRoutes() {
            var routeSelector = document.getElementById('route-selector');
            routeSelector.innerHTML = '<option value="">Seleccionar Ruta</option>';
            var routes = JSON.parse(localStorage.getItem('routes')) || [];
            routes.forEach(function(route, index) {
                var option = document.createElement('option');
                option.value = index;
                option.textContent = `Ruta ${index + 1}`;
                routeSelector.appendChild(option);
            });
        }

        // Guardar ruta
        function saveRoute() {
            var routes = JSON.parse(localStorage.getItem('routes')) || [];
            routes.push(stops);
            localStorage.setItem('routes', JSON.stringify(routes));
            loadRoutes();
            alert('Ruta guardada');
        }

        // Cargar ruta seleccionada
        function loadSelectedRoute() {
            var routeSelector = document.getElementById('route-selector');
            var index = routeSelector.value;
            if (index !== '') {
                var routes = JSON.parse(localStorage.getItem('routes')) || [];
                stops = routes[index];
                selectedRoute = index;
                updateStopList();
                map.eachLayer(function(layer) {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                stops.forEach(function(stop) {
                    L.marker(stop.latlng).addTo(map).bindPopup(`Parada: ${stop.name}, Hora: ${stop.time}`).openPopup();
                });
            }
        }

        // Eliminar ruta seleccionada
        function deleteSelectedRoute() {
            if (selectedRoute !== null) {
                var routes = JSON.parse(localStorage.getItem('routes')) || [];
                routes.splice(selectedRoute, 1);
                localStorage.setItem('routes', JSON.stringify(routes));
                loadRoutes();
                stops = [];
                selectedRoute = null;
                updateStopList();
                map.eachLayer(function(layer) {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                alert('Ruta eliminada');
            }
        }

        map.on('click', function(e) {
            var stopName = prompt("Nombre de la parada:");
            var stopTime = prompt("Hora programada (HH:MM):");
            if (stopName && stopTime) {
                var stop = {
                    name: stopName,
                    time: stopTime,
                    latlng: e.latlng
                };
                stops.push(stop);
                L.marker(e.latlng).addTo(map).bindPopup(`Parada: ${stopName}, Hora: ${stopTime}`).openPopup();
                updateStopList();
            }
        });

        function updateStopList() {
            var stopList = document.getElementById('stops');
            stopList.innerHTML = '';
            stops.forEach(function(stop, index) {
                var li = document.createElement('li');
                li.className = 'stop-item';
                li.textContent = `${index + 1}. ${stop.name} - ${stop.time}`;
                stopList.appendChild(li);
            });
        }

        document.getElementById('save-route-btn').addEventListener('click', saveRoute);

        document.getElementById('delete-route-btn').addEventListener('click', deleteSelectedRoute);

        document.getElementById('route-selector').addEventListener('change', loadSelectedRoute);

        document.getElementById('start-navigation-btn').addEventListener('click', function() {
            if (!navigationActive) {
                navigationActive = true;
                navigationInterval = setInterval(updateNavigation, 5000); // Actualizar cada 5 segundos
                alert('Navegación iniciada');
                updateNavigation(); // Actualizar inmediatamente al iniciar
            }
        });

        document.getElementById('stop-navigation-btn').addEventListener('click', function() {
            if (navigationActive) {
                navigationActive = false;
                clearInterval(navigationInterval);
                alert('Navegación detenida');
            }
        });

        document.getElementById('skip-stop-btn').addEventListener('click', function() {
            if (currentStopIndex < stops.length - 1) {
                currentStopIndex++;
                updateNavigationImmediately();
            }
        });

        document.getElementById('previous-stop-btn').addEventListener('click', function() {
            if (currentStopIndex > 0) {
                currentStopIndex--;
                updateNavigationImmediately();
            }
        });

        function updateNavigation() {
            if (stops.length === 0) return;

            var nextStop = stops[currentStopIndex];
            document.getElementById('next-stop').textContent = `Próxima Parada: ${nextStop.name} - ${nextStop.time}`;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userPosition = L.latLng(position.coords.latitude, position.coords.longitude);
                    var distance = userPosition.distanceTo(nextStop.latlng);

                    if (distance > 20) {
                        currentStopIndex++;
                        if (currentStopIndex < stops.length) {
                            nextStop = stops[currentStopIndex];
                            document.getElementById('next-stop').textContent = `Próxima Parada: ${nextStop.name} - ${nextStop.time}`;
                        }
                    }

                    calculateTimeDifference(nextStop);
                    updateCoordinates(userPosition);
                }, function(error) {
                    alert('Error al obtener la ubicación: ' + error.message);
                });
            } else {
                alert('Geolocalización no soportada por este navegador.');
            }
        }

        function updateNavigationImmediately() {
            if (stops.length === 0) return;

            var nextStop = stops[currentStopIndex];
            document.getElementById('next-stop').textContent = `Próxima Parada: ${nextStop.name} - ${nextStop.time}`;

            if (userPosition) {
                var distance = userPosition.distanceTo(nextStop.latlng);

                if (distance > 20) {
                    currentStopIndex++;
                    if (currentStopIndex < stops.length) {
                        nextStop = stops[currentStopIndex];
                        document.getElementById('next-stop').textContent = `Próxima Parada: ${nextStop.name} - ${nextStop.time}`;
                    }
                }

                calculateTimeDifference(nextStop);
            }
        }

        function calculateTimeDifference(nextStop) {
            var nextStopTimeParts = nextStop.time.split(':');
            var nextStopHours = parseInt(nextStopTimeParts[0], 10);
            var nextStopMinutes = parseInt(nextStopTimeParts[1], 10);
            var nextStopTimeInSeconds = nextStopHours * 3600 + nextStopMinutes * 60;

            var currentTime = new Date();
            var currentHours = currentTime.getHours();
            var currentMinutes = currentTime.getMinutes();
            var currentSeconds = currentTime.getSeconds();
            var currentTimeInSeconds = currentHours * 3600 + currentMinutes * 60 + currentSeconds;

            var timeDiff = nextStopTimeInSeconds - currentTimeInSeconds;
            var sign = timeDiff >= 0 ? '+' : '-';
            timeDiff = Math.abs(timeDiff);

            var minutes = Math.floor(timeDiff / 60);
            var seconds = timeDiff % 60;

            var timeDiffStr = sign + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            document.getElementById('time-difference').textContent = `Diferencia de Tiempo: ${timeDiffStr}`;
        }

        function updateCoordinates(position) {
            document.getElementById('current-coordinates').textContent = `Latitud: ${position.lat.toFixed(6)}, Longitud: ${position.lng.toFixed(6)}`;
        }

        // Solicitar permiso de ubicación y actualizar coordenadas en tiempo real
        function requestLocationPermission() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(function(position) {
                    userPosition = L.latLng(position.coords.latitude, position.coords.longitude);
                    updateCoordinates(userPosition);
                }, function(error) {
                    alert('Error al obtener la ubicación: ' + error.message);
                });
            } else {
                alert('Geolocalización no soportada por este navegador.');
            }
        }

        // Cargar rutas al iniciar
        loadRoutes();

        // Solicitar permiso de ubicación al cargar la página
        requestLocationPermission();
    </script>
</body>
</html>
